<!DOCTYPE html>
<html>
<head>
    <title>Test Video Upload</title>
</head>
<body>
    <h1>Test de Subida de Video</h1>
    
    <h2>1. Login como Admin</h2>
    <button onclick="login()">Login como Admin</button>
    <div id="token-result"></div>
    
    <h2>2. Subir Video</h2>
    <input type="file" id="videoFile" accept=".mp4,.mov,.avi,.mkv">
    <button onclick="uploadVideo()">Subir Video</button>
    <div id="upload-result"></div>
    
    <h2>3. Actualizar Contenido</h2>
    <input type="text" id="videoUrl" placeholder="URL del video subido">
    <button onclick="updateContent()">Actualizar Contenido 1</button>
    <div id="update-result"></div>
    
    <h2>4. Test de Reproducción</h2>
    <video id="testVideo" controls width="400">
        <source id="videoSource" type="video/mp4">
        Tu navegador no soporta video.
    </video>
    <button onclick="testPlayback()">Test Reproducción</button>

    <script>
        let authToken = '';
        
        async function login() {
            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@cursohongos.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    document.getElementById('token-result').innerHTML = '<span style="color: green;">✅ Login exitoso</span>';
                } else {
                    document.getElementById('token-result').innerHTML = '<span style="color: red;">❌ Error en login</span>';
                }
            } catch (error) {
                document.getElementById('token-result').innerHTML = '<span style="color: red;">❌ Error: ' + error.message + '</span>';
            }
        }
        
        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            if (!fileInput.files[0]) {
                alert('Selecciona un archivo');
                return;
            }
            
            if (!authToken) {
                alert('Primero haz login');
                return;
            }
            
            const formData = new FormData();
            formData.append('video', fileInput.files[0]);
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/upload_video', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('upload-result').innerHTML = '<span style="color: green;">✅ Video subido: ' + data.video_url + '</span>';
                    document.getElementById('videoUrl').value = data.video_url;
                } else {
                    document.getElementById('upload-result').innerHTML = '<span style="color: red;">❌ Error: ' + JSON.stringify(data) + '</span>';
                }
            } catch (error) {
                document.getElementById('upload-result').innerHTML = '<span style="color: red;">❌ Error: ' + error.message + '</span>';
            }
        }
        
        async function updateContent() {
            const videoUrl = document.getElementById('videoUrl').value;
            if (!videoUrl) {
                alert('Ingresa la URL del video');
                return;
            }
            
            if (!authToken) {
                alert('Primero haz login');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/course/content/1', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        video_url: videoUrl
                    })
                });
                
                const data = await response.json();
                document.getElementById('update-result').innerHTML = '<span style="color: green;">✅ Contenido actualizado</span>';
            } catch (error) {
                document.getElementById('update-result').innerHTML = '<span style="color: red;">❌ Error: ' + error.message + '</span>';
            }
        }
        
        function testPlayback() {
            const videoUrl = document.getElementById('videoUrl').value;
            if (!videoUrl) {
                alert('Primero sube un video');
                return;
            }
            
            const fullUrl = videoUrl.startsWith('/uploads/') ? `http://localhost:5000${videoUrl}` : videoUrl;
            document.getElementById('videoSource').src = fullUrl;
            document.getElementById('testVideo').load();
        }
    </script>
</body>
</html>
